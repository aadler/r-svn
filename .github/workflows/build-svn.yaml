on: [push, pull_request]

name: Build from SVN

concurrency:
  group: ${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  windows:
    name: Windows
    runs-on: windows-latest
    timeout-minutes: 120
    env:
      R_CRAN_WEB: "https://cran.rstudio.com"
      CRAN_RSYNC: 'mirrors.nic.cz::CRAN'
    defaults:
      run:
        shell: msys2 {0}
    steps:

    - uses: msys2/setup-msys2@v2
      with:
        msystem: MSYS
        install: git make perl curl texinfo texinfo-tex rsync unzip

    - name: Prepare git
      run: git config --global core.autocrlf false

    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 100

    - name: "Download rtools43 toolchain"
      run: |
        url="https://github.com/r-windows/files/releases/download/5493/rtools43-toolchain-libs-base-5493.tar.zst"
        curl -sSL $url | tar x --zstd -C /c/ || true
        echo "RTOOLS43_HOME=c:" >> $GITHUB_ENV
        echo "R_CUSTOM_TOOLS_SOFT=c:/x86_64-w64-mingw32.static.posix" >> $GITHUB_ENV

    - name: System dependencies
      shell: powershell
      run: |
        Import-Module .\.github\workflows\scripts.ps1
        SetTimezone
        InstallMiktex -ErrorAction SilentlyContinue;

    - name: "Fix rsync-recommended"
      run: sed -i.bak 's/rsync -rc/rsync -r/' tools/rsync-recommended

    - name: Build and Check
      run: ./.github/workflows/rtools40-build.sh

    - name: Print failed tests
      if: failure()
      run: tail -n100 tests/*.fail
